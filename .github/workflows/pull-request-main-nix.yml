name: pull-request-main-nix

on:
  merge_group:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  ci-test-e2e:
    name: Tests E2E - Nix setup
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      actions: read
    steps:
      - name: Install Nix
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build TON contracts
        id: ton-contracts-build
        shell: bash
        run: |
          PATH_CONTRACTS_TON_PKG="$(nix build .#chainlink-ton-contracts --print-out-paths)/"
          PATH_CONTRACTS_TON="$PATH_CONTRACTS_TON_PKG/lib/node_modules/@chainlink/contracts-ton/build/"
          echo "path=$PATH_CONTRACTS_TON" >> "$GITHUB_OUTPUT"

      - name: Run e2e tests
        uses: smartcontractkit/.github/actions/ci-test-go@ci-test-go/1.0.0
        with:
          checkout-repo: false
          use-go-cache: true
          go-test-cmd: |
            set +e

            echo "::group::TON"
            export PATH_CONTRACTS_TON="${{ steps.ton-contracts-build.outputs.path }}"
            CTF_CONFIGS=../config.ton.toml go test -p=1 -tags=e2e -v ./e2e/tests/... -run=TestTONSuite || ton_failure=true
            echo "::endgroup::"

            [[ -n "${ton_failure}" ]] && echo "ðŸš¨ TON e2e tests failed."
            [[ -n "${ton_failure}" ]] && {
              exit 1
            } || {
              echo "Exiting"
              exit 0
            }
