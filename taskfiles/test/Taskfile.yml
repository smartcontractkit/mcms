version: '3'

tasks:
  default:
    desc: "Run the entire test suite"
    cmds:
      - task: unit
      - task: e2e

  unit:
    desc: "Run unit tests"
    cmds:
      - go test {{.CLI_ARGS}} ./...

  solana-build-e2e:
    desc: "Build solana image for e2e tests for Mac silicone. You can then run e2e tests for solana."
    cmds:
      - docker build github.com/raphtlw/solana-docker-mac-m1 -t raphtlw/solana

  e2e:
    desc: "Run e2e tests"
    env:
      CTF_CONFIGS: "{{ .CTF_CONFIGS | default \"../config.toml\" }}"
    cmds:
      - CTF_CONFIGS=$CTF_CONFIGS go test -tags=e2e {{.CLI_ARGS}} ./e2e/tests...

  coverage:
    desc: "Run unit test suite with coverage"
    cmds:
      - go test -coverprofile=coverage.out -covermode count ./...
      - go tool cover -html=coverage.out

  ledger:
    desc: "Run ledger signing test"
    cmds:
      - go test -tags=ledger {{.CLI_ARGS}} ./e2e/ledger
